<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0 ,user-scalable=no,target-densitydpi=device-dpi" /> 

<title>addOrUpdate</title>

<style>
	@font-face{
		font-family: "RaphaelIcons";
		src: url('css/fonts/raphaelicons-webfont.ttf');
	}
</style>

<link rel="stylesheet" type="text/css" href="css/newStyle.css" />

 <!--jQuery-->
 <script language="JavaScript" src="js/jquery-1.7.2.min.js"></script>
 <!--jQuery END-->
 <script language="JavaScript" src="js/wavefancy.comm.js"></script>
 <!-- Load jQuery Block UI -->
 <script language="JavaScript" src="js/jquery.blockUI.js"></script>
 <!-- End load jQuery block ui -->

<script>
	var tClick = 0; //title click.
	
	$(document).ready(function(){
		openPage(); // call page open animation
		
		var action = getQueryStringRegExp("action");
		if(action=="update"){
			var id = getQueryStringRegExp("id"); // exception for wrong id.
			
			$("#title").text("修改提醒");
			$("#addItemBTN").val("确认修改提醒");
			
			getItemByID(id);
		}
		
       	//focus then close
		$(".cl").focus(function(){
			$(this).val("");
		});
       	
		//Remove the title remind at the first time. 
		$("#newItem1").click(function(){
			if(tClick <=0){
				$(this).val("");
				tClick ++;
			}
		});

		//automaticall add answer list.
		$("#answer").blur(function(){
			if($(this).val() ==""){
				return;
			}
			
			var c = ' <div oID="-1" class="Line" isEnabled="true"><span class="ndel bLine" > '+$(this).val()+' <span class="RaphaelIcons textGray" style="display: inline-table;">Â</span></span></div>';
			$("#aList").append(c);
			$(this).val("");
			
			//rebine delete option function
			bindDelOption();
			// $(".ndel").click(function(){
    			// $(this).parent().remove();
    		// });
		});
		//remove item.
		// $(".ndel").click(function(){
			// $(this).parent().remove();
		// });
		bindDelOption();
		
		$("#addItemBTN").click(function(){
			addOrUpdateItem();
			//getItemByID();
		});
		
		$("#add_time").click(function(){
  			Activity.pickTime();
		});
		
	}); //----jQuery END-----//
	
	function setTime(hour, minute) {
  		$("#add_time").val(fillString(hour, 2) + ":" + fillString(minute, 2));
	}
	
	function fillString(s, length) {
  		if(!String.repeat){//判断是否存在这个方法
    		String.prototype.repeat = function(l){//创建repeat方法
    			return new Array(l+1).join(this);//创建元素值为空、个数为重复次数+1的数组，用字符串自身做为分隔符连接起来，返回连接后的值。
    		}
    	}
  		return '0'.repeat(length - s.length) + s;
	}
	
	//bind funtion for delete option.
	function bindDelOption(){
		$(".ndel").click(function(){
			$(this).parent().hide();
			$(this).parent().attr("isEnabled",false);
		});
	}
	
	function addOrUpdateItem(){ //add or update.
		//	alert("here!");
			var q = new Object();
			q.id = $("#addItem").attr("dID"); //add negative add, alter positive id.
			q.question = $("#newItem1").val();
			
			q.options = [];
			
			$("#aList").children().each(function(){
				//alert($(this).text().trim().length);
				var s = $(this).text().trim();
				var o = new Object();
				o.option = s.substring(0,s.length-1);
				o.id = $(this).attr("oID");
				o.isEnabled = $(this).attr("isEnabled");
		//		alert(s.substring(0,s.length-1));
				q.options.push(o);
			});	
		
			q.repeatType = "1";
			q.interval = $("#add_repeat").val();
			var t = $("#add_time").val().split(":");
			q.hour = parseInt(t[0]);
			q.minute = parseInt(t[1]);
			q.alertType = "2";
			
			
			alert(JSON.stringify(q));
			if(q.id <=0 ){
				if (Android.processQuestion(JSON.stringify(q), "create") == 0) {
					blockUINoOverlay("添加提醒成功！");
					unBlockUI(oTime);
				}
			}else{

				if (Android.processQuestion(JSON.stringify(q), "update") == 0) {
					blockUINoOverlay("修改提醒成功！");
					unBlockUI(oTime);
				}
			}
			 
	}
	
	function getItemByID(id){ //get question by ID.
		//var result = '{"id":"1","question":"请添加提醒问题","options":[{"option":"是12 ","id":"1"},{"option":"否 ","id":"2"}],"repeat_type":"2","hour":"13","minute":"15"}';
		var result = Android.processQuestion(id, "getItemByID");
		var q = eval('('+result+')');
		//alert(q.question);
		$("#addItem").attr("dID",q.id);
		$("#newItem1").val(q.question);
		$("#add_repeat").val(q.repeatType);
		$("#add_time").val(fillString(q.hour + '', 2) + ':' + fillString(q.minute + '', 2));
		//$("#add_time").val(q.hour + ":" + q.minute);
		
		$("#aList").empty();
		for(var i in q.options){
			//alert(q.options[i].id);
			var e = '<div class="Line" oID="'+q.options[i].id+'" isEnabled="true"><span class="ndel bLine" > '+q.options[i].option+' <span class="RaphaelIcons textGray" style="display: inline-table;">Â</span></span></div>'
			$("#aList").append(e);
		}
		
		//don't remove the title content when focus on.
		tClick = 1;
	};
		
</script>
</head>
<body>
<div id="topPanel">

	<div id="topLine">
	<!-- 
		<div id="tl1"></div> <div id="tl2"></div> <div id="tl3"></div> <div id="tl4"></div> <div id="tl5"></div>
	 -->
	</div>
	<div id="move"></div>
	<!-- 添加或更新提醒 panel  -->
					<section class="st-panel" id="st-panel-1">						
						<h3><span class="RaphaelIcons textGreen" style="display: inline-table;">E<span id="title" class="textOrange" style="margin-left:10px;">添加提醒</span></span></h3>
			<!-- ADD ITEM -->			
						<div id="addItem" dID="-1">
							<input id="newItem1" class="cInput" value="请添加提醒问题"/>
						    	<div style="text-align:right;">
						    		<div class="Line">
						    			<span class="bLine" style="width:50%;"> <input id="answer" class="lInput cl" value="请添加备选回答项"/> <span class="RaphaelIcons textGreen" style="display: inline-table;">@</span></span>
						    		</div>
						    	<div id="aList">	
						    		<div class="Line" oID="-1" isEnabled="true">
						    		   	<span class="bLine ndel" > 是 <span class="RaphaelIcons textGray" style="display: inline-table;">Â</span></span>
						    		</div>
						    		<div class="Line" oID="-1" isEnabled="true">
						    		   	<span class="bLine ndel" > 否 <span class="RaphaelIcons textGray" style="display: inline-table;">Â</span></span>
						    		</div>
						    	</div>
						    	
						    		<div class="Line">
						    			<span class="bLine" style="width:50%; height:30px;"> 重复周期 <input id="add_repeat" class="lInput" value="2" style="width:20px;color:#12AAEE;font-size:14px;"/> 天 <span class="RaphaelIcons textGreen" style="display: inline-table;">4</span></span>
						    		</div>
						    		<div class="Line">
						    			<span class="bLine" style="width:50%; height:30px;"> 提醒时间 <input id ="add_time" type="button" class="lInput" value="13:36" style="width:50px;color:#12AAEE;font-size:14px;"/><span class="RaphaelIcons textGreen mobiscroll" style="display: inline-table;">3</span></span>
						    		</div>
						    		
						    		<div class="bLine"></div>
						    		<div>
						    		  <span class="bLine" style="width:50%; height:30px;"><span class="RaphaelIcons textGreen" style="display: inline-table;">Ã</span>设置完成</span>
								      <input id="addItemBTN" class="button" type="button" value="确认添加提醒"/>
								    </div>
						    	</div>
						    
						</div>
					</section>
				<!--END ADD ITEM -->	
</div>
</body>
</html>
